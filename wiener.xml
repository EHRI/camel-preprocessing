<?xml version="1.0" encoding="UTF-8"?>
<blueprint
    xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="
      http://www.osgi.org/xmlns/blueprint/v1.0.0
      http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd">

    <camelContext xmlns="http://camel.apache.org/schema/blueprint" xsi:schemaLocation="
    http://camel.apache.org/schema/blueprint
    http://camel.apache.org/schema/blueprint/camel-blueprint.xsd" id="ehri-wiener-library">

      <route id="unwrap">
        <from uri="file:///opt/webapps/data/repoxData/export/wienerlib?noop=true&amp;include=.*\.xml"/>

        <filter>
            <xpath>//ead</xpath>
            <transform><xpath>//ead</xpath></transform>
            <log message="Unwrapping ${file:name}..."/>
            <to uri="file:///opt/webapps/data/camel/wiener1"/>
        </filter>
      </route>

      <route id="convert-extref">

        <from uri="file:///opt/webapps/data/camel/wiener1?delete=true"/>
        <log message="Transforming external links to Markdown in ${file:name}..."/>
        <to uri="xslt:file:///opt/webapps/ehri-ead-preprocessing/convert-extref/convert-extref.xsl?saxon=true"/>
        <to uri="file:///opt/webapps/data/camel/wiener2"/>
      </route>

      <route id="convert-emph">

        <from uri="file:///opt/webapps/data/camel/wiener2?delete=true"/>
        <log message="Transforming emphasis to Markdown in ${file:name}..."/>
        <to uri="xslt:file:///opt/webapps/ehri-ead-preprocessing/convert-emph/convert-emph.xsl?saxon=true"/>
        <to uri="file:///opt/webapps/data/camel/wiener3"/>
      </route>

      <route id="move-to-import">

        <from uri="file:///opt/webapps/data/camel/wiener3?delete=true"/>
        <setHeader headerName="CamelFileName">
            <xquery type="java.lang.String">let $eadid := //eadid
            let $eadidt := fn:replace(fn:normalize-space($eadid/string()), "\p{Zs}", "_")
            return fn:concat($eadid/@countrycode, "/", $eadid/@mainagencycode, "/", $eadidt, ".xml")
            </xquery>
        </setHeader>
        <log message="Moving ${file:name} to import..."/>
        <to uri="file:///opt/webapps/data/import-data/"/>
      </route>
    </camelContext>


</blueprint>
